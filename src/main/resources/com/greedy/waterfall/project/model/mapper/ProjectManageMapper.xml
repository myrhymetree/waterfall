<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.greedy.waterfall.project.model.mapper.ProjectManageMapper">
	
	<resultMap type="com.greedy.waterfall.project.model.dto.ProjectManageMemberDTO" id="projectMemberResult">
		<result property="projectNo" column="PROJECT_NO"/>
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="memberName" column="MEMBER_NAME"/>
		<result property="completeTask" column="COMPLETE_TASK"/>
		<result property="progressingTask" column="PROGRESSING_TASK"/>
		<result property="registOutput" column="REGIST_OUTPUT"/>
		<result property="registIssue" column="REGIST_ISSUE"/>
		<result property="joinDate" column="PROJECT_MEM_STARTED_DATE"/>
		<result property="quitDate" column="PROJECT_MEM_DROP_DATE"/>
		
		<collection property="role" resultMap="projectRole"/>
		
	</resultMap>
	
	<resultMap type="com.greedy.waterfall.project.model.dto.DeptDTO" id="deptResult">
		<id property="deptCode" column="DEPT_CODE"/>
		<result property="deptName" column="DEPT_NAME"/>
	</resultMap>
	
	<resultMap type="com.greedy.waterfall.project.model.dto.ProjectRoleDTO" id="projectRole">
		<id property="roleNo" column="ROLE_NO"/>
		<result property="roleName" column="ROLE_NAME"/>
	</resultMap>
	
	<select id="findProjectMember" resultMap="projectMemberResult">
        SELECT 
               A.PROJECT_NO
             , C.MEMBER_NAME
             , D.ROLE_NAME
             , E.PROJECT_MEM_STARTED_DATE
             , E.PROJECT_MEM_DROP_DATE
             , (SELECT COUNT(*)
                  FROM TBL_TASK F
                 WHERE F.PROJECT_NO = A.PROJECT_NO
                   AND F.MEMBER_NO = A.MEMBER_NO
                   AND F.TASK_PROGRESS_STATUS = '완료'
               ) AS COMPLETE_TASK
             , (SELECT COUNT(*)
                  FROM TBL_TASK G
                 WHERE G.PROJECT_NO = A.PROJECT_NO
                   AND G.MEMBER_NO = A.MEMBER_NO
                   AND G.TASK_PROGRESS_STATUS = '진행중'
               ) AS PROGRESSING_TASK
             , (SELECT COUNT(*)
                  FROM TBL_OUTPUT H
                 WHERE H.PROJECT_NO = A.PROJECT_NO
                   AND H.MEMBER_NO = A.MEMBER_NO
               ) AS REGIST_OUTPUT
             , (SELECT COUNT(*)
                  FROM TBL_ISSUE I
                 WHERE I.PROJECT_NO = A.PROJECT_NO
                   AND I.ISSUE_REGISTER = A.MEMBER_NO
               ) AS REGIST_ISSUE
          FROM (SELECT B.PROJECT_NO
                     , B.MEMBER_NO
                     , B.ROLE_NO
                  FROM TBL_ROLE_ASSIGNMENT_HISTORY B
                 WHERE B.ROLE_NO != 8
                   AND B.PROJECT_NO = #{ projectNo }
               ) A
          JOIN TBL_MEMBER C ON (A.MEMBER_NO = C.MEMBER_NO)
          JOIN TBL_ROLE_CATEGORY D ON (A.ROLE_NO = D.ROLE_NO)
          JOIN TBL_PROJECT_MEM_HISTORY E ON (A.MEMBER_NO = E.MEMBER_NO)
         WHERE E.PROJECT_NO = #{ projectNo }
	</select>
    <select id="findAllRole" resultMap="projectRole">
        SELECT
               A.ROLE_NO
             , A.ROLE_NAME
          FROM TBL_ROLE_CATEGORY A
         WHERE A.ROLE_NO != 8
         ORDER BY A.ROLE_NO
    </select>
   	<select id="findAllDept" resultMap="deptResult">
        SELECT
               A.DEPT_CODE
             , A.DEPT_NAME
          FROM TBL_DEPT A
	</select>
	
</mapper>






























