<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.greedy.waterfall.issue.model.mapper.IssueMapper">
     <resultMap type="com.greedy.waterfall.issue.model.dto.IssueDTO" id="issueResultMap">
        <id property="no" column="ISSUE_NO"></id>
        <result property="rnum" column="RNUM"/>
        <result property="name" column="ISSUE_NAME"/>
        <result property="createdDate" column="ISSUE_CREATED_DATE"/>
        <result property="progressStatus" column="ISSUE_PROGRESS_STATUS"/>
        <result property="importance" column="ISSUE_IMPORTANCE"/>
        <result property="content" column="ISSUE_CONTENT"/>
        <result property="deadline" column="ISSUE_DEADLINE"/>
        <result property="completedDate" column="ISSUE_COMPLETED_DATE"/>
        <result property="status" column="ISSUE_STATUS"/>
        <result property="registerNo" column="ISSUE_REGISTER"/>
        <result property="managerNo" column="ISSUE_MANAGER"/>
        <result property="projectNo" column="PROJECT_NO"/>
        <result property="taskNo" column="TASK_NO"/>
        
        <association property="register" resultMap="registerResultMap"/>
        <association property="manager" resultMap="managerResultMap"/>
        <association property="project" resultMap="projectResultMap"/>
        <association property="task" resultMap="taskResultMap"/>
        <association property="taskCode" resultMap="taskCodeResultMap"/>
     </resultMap>
     
     <resultMap type="com.greedy.waterfall.issue.model.dto.IssueRegisterDTO" id="registerResultMap">
     	<id property="no" column="ISSUE_REGISTER"/>
     	<result property="name" column="REGISTER_NAME"/>
     </resultMap>
     
     <resultMap type="com.greedy.waterfall.issue.model.dto.IssueManagerDTO" id="managerResultMap">
     	<id property="no" column="ISSUE_MANAGER"/>
     	<result property="name" column="MANAGER_NAME"/>
     </resultMap>
  
  	<resultMap type="com.greedy.waterfall.issue.model.dto.IssueProjectDTO" id="projectResultMap">
  		<id property="no" column="PROJECT_NO"/>
  		<result property="name" column="PROJECT_NAME"/>
  	</resultMap>
  	
  	<resultMap type="com.greedy.waterfall.issue.model.dto.IssueTaskDTO" id="taskResultMap">
  		<id property="no" column="TASK_NO"/>
  		<result property="taskCategoryCode" column="TASK_CATEGORY_CODE"/>
  		<result property="taskRefNo" column="TASK_REF_NO"/>
  	</resultMap>
  	
  	<resultMap type="com.greedy.waterfall.issue.model.dto.IssueTaskCodeManageDTO" id="taskCodeResultMap">
  		<id property="taskCategoryCode" column="TASK_CATEGORY_CODE"/>
  		<result property="taskCategoryName" column="TASK_CATEGORY_NAME"/>
  	</resultMap>
  	
  	<resultMap type="com.greedy.waterfall.issue.model.dto.ProjectIssueCountDTO" id="projectIssueCountResultMap">
  		<id property="projectNo" column="PROJECT_NO"/>
  		<result property="projectName" column="PROJECT_NAME"/>
  		<result property="allIssueCount" column="ALL_ISSUE_COUNT"/>
  		<result property="pendingIssueCount" column="PENDING_ISSUE_COUNT"/>
  		<result property="processingIssueCount" column="PROCESSING_ISSUE_COUNT"/>
  		<result property="completedIssueCount" column="COMPLETED_ISSUE_COUNT"/>
  		<result property="managerNo" column="PM_NO"/>
  		<result property="pmName" column="PM_NAME"/>
  		
  		<association property="project" resultMap="projectResultMap"/>
  	</resultMap>
  	
  	
	<select id="selectTotalCount" resultType="_int" parameterType="hashmap">
	 SELECT /* com.greedy.waterfall.issue.model.mapper.IssueMapper#selectTotalCount() */
	 	    COUNT(*)
	   FROM TBL_ISSUE A
	  <where>
	 	<if test="searchCondition == 'title'">
	    	A.ISSUE_NAME LIKE '%' || #{ searchValue } || '%'
	 	</if>
	 	<if test="searchCondition == 'content'">
	 		A.ISSUE_CONTENT LIKE '%' || #{ searchValue } || '%'
	 	</if>
	   AND A.ISSUE_STATUS = 'Y'
	 </where> 	    
	</select>
  	
  	<select id="selectAllIssueList" resultMap="issueResultMap">
  	SELECT /* com.greedy.com.greedy.waterfall.issue.model.mapper.IssueMapper#selectAllIssueList() */
            A.RNUM
          , A.ISSUE_NO
          , A.ISSUE_NAME
          , A.ISSUE_CREATED_DATE
		  , A.ISSUE_PROGRESS_STATUS
		  , A.ISSUE_IMPORTANCE
		  , A.ISSUE_CONTENT
		  , A.ISSUE_DEADLINE
		  , A.ISSUE_COMPLETED_DATE 
		  , A.ISSUE_STATUS
		  , A.ISSUE_REGISTER
		  , A.PROJECT_NO
		  , A.ISSUE_MANAGER 
		  , A.TASK_NO
		  , D.MEMBER_NAME AS REGISTER_NAME
		  , H.MEMBER_NAME AS MANAGER_NAME
		  , E.PROJECT_NAME
		  , G.TASK_CATEGORY_NAME
      FROM ( SELECT ROWNUM RNUM
                  , B.ISSUE_NO
                  , B.ISSUE_NAME
                  , B.ISSUE_CREATED_DATE
		          , B.ISSUE_PROGRESS_STATUS
		          , B.ISSUE_IMPORTANCE
		          , B.ISSUE_CONTENT
		          , B.ISSUE_DEADLINE
		          , B.ISSUE_COMPLETED_DATE
		          , B.ISSUE_STATUS
		          , B.ISSUE_REGISTER
		          , B.PROJECT_NO
		          , B.ISSUE_MANAGER
		          , B.TASK_NO
               FROM ( SELECT  C.ISSUE_NO
  		                    , C.ISSUE_NAME
  		                    , C.ISSUE_CREATED_DATE
			                , C.ISSUE_PROGRESS_STATUS
			                , C.ISSUE_IMPORTANCE
			                , C.ISSUE_CONTENT
			                , C.ISSUE_DEADLINE
			                , C.ISSUE_COMPLETED_DATE
			                , C.ISSUE_STATUS
			                , C.ISSUE_REGISTER
			                , C.PROJECT_NO
			                , C.ISSUE_MANAGER
			                , C.TASK_NO
		                 FROM TBL_ISSUE C
		                <where>
		                 <if test="searchCondition == 'title'">
		  	                 C.ISSUE_NAME LIKE '%' || #{ searchValue } || '%'
		                 </if>
		                 <if test="searchCondition == 'content'">
		  	                 C.ISSUE_CONTENT LIKE '%' || #{ searchValue } || '%'
		                 </if>
		                 AND C.ISSUE_STATUS = 'Y'
		               </where> 
		               ORDER BY ISSUE_NO DESC
		               ) B
				       <![CDATA[
				       WHERE ROWNUM <= #{ endRow }
				       ]]>
				       ) A
				  JOIN TBL_MEMBER D ON (A.ISSUE_REGISTER = D.MEMBER_NO)
				  JOIN TBL_PROJECT E ON (A.PROJECT_NO = E.PROJECT_NO)
				  JOIN TBL_TASK F ON (A.TASK_NO = F.TASK_NO)
				  JOIN TBL_TASK_CODE_MANAGE G ON (F.TASK_CATEGORY_CODE = G.TASK_CATEGORY_CODE)
				  JOIN TBL_MEMBER H ON (A.ISSUE_MANAGER = H.MEMBER_NO)
			     WHERE A.RNUM >= #{ startRow }
			     ORDER BY 1 ASC 
  	</select>
  	
  	<select id="selectAllProjectList" resultMap="projectIssueCountResultMap">
  		SELECT /* com.greedy.com.greedy.waterfall.issue.model.mapper.IssueMapper#selectAllProjectList() */
  	  DISTINCT
  	             ROWNUM RNUM
			   , A.PROJECT_NO
			   , B.PROJECT_NAME
			   , (SELECT
                         COUNT(C.ISSUE_NO) AS ALL_ISSUE_COUNT
	                FROM TBL_ISSUE C 
                   WHERE C.ISSUE_STATUS = 'Y'
                     AND C.PROJECT_NO = C.PROJECT_NO
                  ) AS ALL_ISSUE_COUNT
                , ( SELECT
                           COUNT(D.ISSUE_NO) 
                      FROM TBL_ISSUE D
                     WHERE D.ISSUE_STATUS = 'Y'
                       AND D.ISSUE_PROGRESS_STATUS = '대기중'
                       AND D.PROJECT_NO = D.PROJECT_NO
                  ) AS PENDING_ISSUE_COUNT
                , ( SELECT
                           COUNT(E.ISSUE_NO)  
                      FROM TBL_ISSUE E
                     WHERE E.ISSUE_STATUS = 'Y'
                       AND E.ISSUE_PROGRESS_STATUS = '처리중'
                       AND E.PROJECT_NO = E.PROJECT_NO
                   ) AS PROCESSING_ISSUE_COUNT
                 , ( SELECT
                            COUNT(F.ISSUE_NO) 
                       FROM TBL_ISSUE F
                      WHERE F.ISSUE_STATUS = 'Y'
                        AND F.ISSUE_PROGRESS_STATUS = '완료'
                        AND F.PROJECT_NO = F.PROJECT_NO
                    ) AS COMPLETED_ISSUE_COUNT
			   , G.MANAGER_NO AS PM_NO
			   , H.MEMBER_NAME AS PM_NAME
	        FROM TBL_ISSUE A
	        JOIN TBL_PROJECT B ON (A.PROJECT_NO = B.PROJECT_NO)
	        JOIN TBL_PROJECT_MEM_HISTORY G ON (A.PROJECT_NO = G.PROJECT_NO)
            JOIN TBL_MEMBER H ON (G.MANAGER_NO = H.MEMBER_NO)
	       WHERE B.PROJECT_STATUS = 'Y'
  	</select>
  	
  	<select id="selectIssuesOfTask" parameterType="_int" resultMap="issueResultMap" >
  		SELECT
                A.PROJECT_NO
              , B.PROJECT_NAME
              , A.TASK_NO
              , D.TASK_CATEGORY_NAME
              , A.ISSUE_NO
              , A.ISSUE_NAME
           FROM TBL_ISSUE A
           JOIN TBL_PROJECT B ON (A.PROJECT_NO = B.PROJECT_NO)
           JOIN TBL_TASK C ON (A.TASK_NO = C.TASK_NO)
           JOIN TBL_TASK_CODE_MANAGE D ON (C.TASK_CATEGORY_CODE = D.TASK_CATEGORY_CODE)
          WHERE A.ISSUE_STATUS = 'Y'
	        AND B.PROJECT_STATUS = 'Y'
	        AND C.TASK_STATUS = 'Y'
	        AND A.PROJECT_NO = #{ projectNo }
  	</select>
  
  </mapper>