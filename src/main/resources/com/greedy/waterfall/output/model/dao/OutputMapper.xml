<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.greedy.waterfall.output.model.dao.OutputMapper">
	<resultMap type="com.greedy.waterfall.output.model.dto.OutputDTO" id="outputResultMap">
	<id property="outputNo" column="OUTPUT_NO"/>
	<result property="outputVer" column="OUTPUT_VER"/>
	<result property="content" column="OUTPUT_COMMENT"/>
	<result property="registedDate" column="OUTPUT_REGISTED_DATE"/>
	<result property="status" column="OUTPUT_STATUS"/>
	<result property="memberNo" column="MEMBER_NO"/>
	<result property="projectNo" column="PROJECT_NO"/>
	
	<association property="memberName" resultMap="memberResultMap"></association>
	<association property="outputFile" resultMap="fileResultMap"></association>
	<association property="project" resultMap="projectResultMap"></association>
	</resultMap>
	
	<resultMap type="com.greedy.waterfall.task.model.dto.TaskDTO" id="taskResultMap">
		<id property="taskNo" column="TASK_NO"/>
		<result property="parentTaskNo" column="TASK_REF_NO"/>
		<result property="startDate" column="TASK_START_DATE"/>
		<result property="deadline" column="TASK_DEADLINE"/>
		<result property="progression" column="TASK_PROGRESSION"/>
		<result property="typeNo" column="TASK_TYPE_NO"/>
		<result property="taskStatus" column="TASK_STATUS"/>
		<result property="progressStatus" column="TASK_PROGRESS_STATUS"/>
		<result property="taskStatus" column="TASK_STATUS"/>
		<result property="taskCode" column="TASK_CATEGORY_CODE"/>
		<result property="projectNo" column="PROJECT_NO"/>
		<result property="managerNo" column="MEMBER_NO"/>
		<result property="projectName" column="PROJECT_NAME"/>
		
		<association property="taskCategory" resultMap="taskCategoryResultMap"></association>
		<collection property="childList" resultMap="childTaskResultMap"></collection>
	</resultMap>
	
	<resultMap type="com.greedy.waterfall.task.model.dto.ChildTaskDTO" id="childTaskResultMap">
		<id property="taskNo" column="TASK_NO"/>
		<result property="parentTaskNo" column="TASK_REF_NO"/>
		<result property="startDate" column="TASK_START_DATE"/>
		<result property="deadline" column="TASK_DEADLINE"/>
		<result property="progression" column="TASK_PROGRESSION"/>
		<result property="taskStatus" column="TASK_STATUS"/>
		<result property="progressStatus" column="TASK_PROGRESS_STATUS"/>
		<result property="taskCode" column="TASK_CATEGORY_CODE"/>
		<result property="projectNo" column="PROJECT_NO"/>
		<result property="managerNo" column="MEMBER_NO"/>
		<result property="typeNo" column="TASK_TYPE_NO"/>
		
		<association property="taskCategory" resultMap="taskCategoryResultMap"></association>
	</resultMap>
	
	<resultMap type="com.greedy.waterfall.member.model.dto.MemberDTO" id="memberResultMap">
		<id property="no" column="MEMBER_NO"/>
		<result property="name" column="MEMBER_NAME"/>
	</resultMap>
	
	<resultMap type="com.greedy.waterfall.output.model.dto.OutputProjectDTO" id="projectResultMap">
		<id property="no" column="PROJECT_NO"/>
		<result property="name" column="PROJECT_NAME"/>
		<result property="startDate" column="PROJECT_START_DATE"/>
		<result property="deadLine" column="PROJECT_DEADLINE"/>
		<result property="progression" column="PROJECT_PROGRESSION"/>
		<result property="statusCode" column="PROJECT_PROGRESS_STATUS_CODE"/>
		
		<association property="status" resultMap="projectStatusResultMap"/>
		<association property="manager" resultMap="memberResultMap"/>
	</resultMap>
	
	<resultMap type="com.greedy.waterfall.task.model.dto.TaskCategoryDTO" id="taskCategoryResultMap">
		<id property="categoryCode" column="TASK_CATEGORY_CODE"/>
		<result property="categoryName" column="TASK_CATEGORY_NAME"/>
	</resultMap>
	
	<resultMap type="com.greedy.waterfall.output.model.dto.OutputAttachmentDTO" id="fileResultMap">
		<id property="fileNo" column="OUTPUT_FILE_NO"/>
		<result property="filePath" column="OUTPUT_FILE_PATH"/>
		<result property="originName" column="OUTPUT_ORIGIN_NAME"/>
		<result property="randomName" column="OUTPUT_RANDOM_NAME"/>
		<result property="status" column="OUTPUT_STATUS"/>
		<result property="registedDate" column="OUTPUT_REGISTED_DATE"/>
		<result property="outputNo" column="REF_OUTPUT_NO"/>
	</resultMap>
	
	<resultMap type="com.greedy.waterfall.output.model.dto.OutputProjectStatusDTO" id="projectStatusResultMap">
		<id property="projectStatusCode" column="PROJECT_PROGRESS_STATUS_CODE"/>
		<result property="projectStatusName" column="PROJECT_PROGRESS_STATUS_NAME"/>
	</resultMap>
	
		
	<select id="selectParentTaskList" resultMap="taskResultMap">
		SELECT
		       A.TASK_CATEGORY_CODE
		     , B.TASK_CATEGORY_NAME
		     , A.TASK_NO
		  FROM TBL_TASK A
		  JOIN TBL_TASK_CODE_MANAGE B ON(A.TASK_CATEGORY_CODE = B.TASK_CATEGORY_CODE ) 
		 WHERE A.PROJECT_NO = #{ projectNo }
		   AND A.TASK_REF_NO IS NULL
		   AND A.TASK_STATUS = 'Y'
	</select>
	
	<select id="selectChildTaskList" resultMap="childTaskResultMap">
		SELECT
		       A.TASK_CATEGORY_CODE
		     , B.TASK_CATEGORY_NAME
		     , A.TASK_NO
		  FROM TBL_TASK A
		  JOIN TBL_TASK_CODE_MANAGE B ON(A.TASK_CATEGORY_CODE = B.TASK_CATEGORY_CODE ) 
		 WHERE A.TASK_STATUS = 'Y'
		   AND A.TASK_REF_NO = #{taskNo}
		 	
	</select>
	
	<select id="selectChildTask" resultMap="childTaskResultMap">
		SELECT
		       A.TASK_REF_NO
		     , A.TASK_START_DATE
		     , A.TASK_DEADLINE
		     , A.TASK_PROGRESSION
		     , A.TASK_PROGRESS_STATUS
		     , A.TASK_TYPE_NO
		     , A.TASK_STATUS
		     , A.PROJECT_NO
		     , A.MEMBER_NO
		     , A.TASK_CATEGORY_CODE
		     , B.TASK_CATEGORY_NAME
		  FROM TBL_TASK A
		  JOIN TBL_TASK_CODE_MANAGE B ON(A.TASK_CATEGORY_CODE = B.TASK_CATEGORY_CODE )
		 WHERE A.TASK_STATUS = 'Y'
		   AND A.TASK_NO = #{ taskNo }
	</select>
	
	<select id="selectOutputDetail" resultMap="outputResultMap">
		SELECT
		       A.OUTPUT_NO
		     , A.OUTPUT_COMMENT
		     , A.OUTPUT_REGISTED_DATE
		     , A.OUTPUT_STATUS
		     , A.MEMBER_NO
		     , B.MEMBER_NAME
		     , A.PROJECT_NO
		     , A.OUTPUT_VER
		     , C.OUTPUT_ORIGIN_NAME
		     , D.PROJECT_NAME
		  FROM TBL_OUTPUT A
		  JOIN TBL_MEMBER B ON(A.MEMBER_NO = B.MEMBER_NO)
		  LEFT JOIN TBL_OUTPUT_FILE C ON(A.OUTPUT_NO = C.REF_OUTPUT_NO)
		  JOIN TBL_PROJECT D ON(A.PROJECT_NO = D.PROJECT_NO)
		 WHERE A.OUTPUT_STATUS = 'Y'
		   AND A.TASK_NO = #{ taskNo }
	</select>
	
	<select id="selectParentTask" resultMap="taskResultMap">
		SELECT
		        A.TASK_START_DATE
		      , A.TASK_DEADLINE
		      , A.TASK_PROGRESSION
		      , A.TASK_STATUS
		      , A.TASK_PROGRESS_STATUS
		      , A.TASK_CATEGORY_CODE
		      , A.PROJECT_NO
		      , C.PROJECT_NAME
		      , A.MEMBER_NO
		      , A.TASK_TYPE_NO
		      , B.TASK_CATEGORY_NAME
		  FROM TBL_TASK A
		  JOIN TBL_TASK_CODE_MANAGE B ON(A.TASK_CATEGORY_CODE = B.TASK_CATEGORY_CODE )
		  JOIN TBL_PROJECT C ON (A.PROJECT_NO = C.PROJECT_NO)
		 WHERE A.TASK_REF_NO IS NULL
		   AND A.TASK_STATUS = 'Y' 
		   AND A.TASK_NO = #{ parentTaskNo }
	</select>
	
	<update id="deleteOutput">
		UPDATE
		       TBL_OUTPUT A
		   SET A.OUTPUT_STATUS = 'N'
		 WHERE OUTPUT_NO = #{ no }
	</update>
	
	<select id="selectAllProjectList" resultMap="projectResultMap">
		SELECT 
			   A.PROJECT_NO
			 , A.PROJECT_NAME
			 , A.PROJECT_PROGRESSION
			 , B.PROJECT_PROGRESS_STATUS_NAME
			 , D.MEMBER_NAME
          FROM TBL_PROJECT A
          JOIN TBL_PROJECT_STATUS B ON(A.PROJECT_PROGRESS_STATUS_CODE = B.PROJECT_PROGRESS_STATUS_CODE)
          JOIN TBL_ROLE_ASSIGNMENT_HISTORY C ON(A.PROJECT_NO = C.PROJECT_NO)
          LEFT JOIN TBL_MEMBER D ON(C.MEMBER_NO = D.MEMBER_NO)
 	     WHERE A.PROJECT_STATUS = 'Y'
 	       
 	       AND C.ROLE_HISTORY_NO IN (SELECT MAX(ROLE_HISTORY_NO)
 	                                  FROM TBL_ROLE_ASSIGNMENT_HISTORY E
 	                                 WHERE E.ROLE_NO = 8
 	                                 GROUP BY PROJECT_NO
 	                                          )
	</select>
	
	<select id="selectAlloutputCount" resultType="_int">
		SELECT
		       COUNT(*)
		  FROM TBL_OUTPUT
		 WHERE PROJECT_NO = #{ projectNo }
		   AND OUTPUT_STATUS = 'Y'
		       
	</select>
	
	<select id="selectAdminOutputList" resultMap="outputResultMap">
		SELECT
		       A.OUTPUT_NO
		     , A.OUTPUT_COMMENT
		     , A.OUTPUT_REGISTED_DATE
		     , A.OUTPUT_STATUS
		     , A.MEMBER_NO
		     , B.MEMBER_NAME
		     , A.PROJECT_NO
		     , A.OUTPUT_VER
		  FROM TBL_OUTPUT A
		  LEFT JOIN TBL_MEMBER B ON (A.MEMBER_NO = B.MEMBER_NO)
		 WHERE A.PROJECT_NO = #{ projectNo }  
	</select>
	
	<insert id="insertOutput">
		INSERT
		  INTO TBL_OUTPUT A
		     (
		       A.OUTPUT_NO
		     , A.OUTPUT_COMMENT
		     , A.OUTPUT_REGISTED_DATE
		     , A.OUTPUT_STATUS
		     , A.MEMBER_NO
		     , A.PROJECT_NO
		     , A.TASK_NO
		     , A.OUTPUT_VER
		     )
		     VALUES
		     (
		       OUTPUT_NO.NEXTVAL
		     , #{ content }
		     , SYSDATE
		     , 'Y'
		     , #{ memberNo }
		     , #{ projectNo }
		     , #{ taskNo }
		     , 1
		     )
	</insert>
	
	<insert id="insertOutputAttachment">
		INSERT
		  INTO TBL_OUTPUT_FILE 
		     (
		       OUTPUT_FILE_NO
		     , OUTPUT_FILE_PATH
		     , OUTPUT_ORIGIN_NAME
		     , OUTPUT_RANDOM_NAME
		     , OUTPUT_STATUS
		     , OUTPUT_REGISTED_DATE
		     , REF_OUTPUT_NO
		     )
		     VALUES
		     (
		       OUTPUT_FILE_NO.NEXTVAL
		     , #{ filePath }
		     , #{ originName }
		     , #{ randomName }
		     , 'Y'
		     , SYSDATE
		     , OUTPUT_NO.CURRVAL
		     )
	</insert>
	
	<insert id="insertOutputHistory">
		INSERT
		  INTO TBL_OUTPUT_HISTORY
		     (
		       OUTPUT_HISTORY_NO
		     , OUTPUT_HISTORY_DATE
		     , OUTPUT_HISTORY_CONDITION
		     , OUTPUT_NO
		     , MEMBER_NO
		     )
		     VALUES
		     (
		       OUTPUT_HISTORY_NO.NEXTVAL
		     , SYSDATE
		     , '등록'
		     , OUTPUT_NO.CURRVAL
		     , #{ memberNo }
		     )
	</insert>
	
	<select id="selectOutputFile" resultMap="fileResultMap">
		SELECT
		       OUTPUT_FILE_NO
		     , OUTPUT_FILE_PATH
		     , OUTPUT_ORIGIN_NAME
		     , OUTPUT_RANDOM_NAME
		     , OUTPUT_STATUS
		     , OUTPUT_REGISTED_DATE
		     , REF_OUTPUT_NO
		  FROM TBL_OUTPUT_FILE
		 WHERE REF_OUTPUT_NO = #{ outputNo }
	</select>
	
	
</mapper>